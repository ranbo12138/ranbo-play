# ranbo-play 项目文档总结

本文档是对 `/docs` 目录下所有文档的详细总结，用于后续的 vibe coding 工作。

## 📋 文档概览

项目包含以下5个核心文档：
1. `readme.md` - 说明文档用途
2. `MVU框架的角色卡制作教程.md` - MVU变量系统完整教程
3. `酒馆世界书拓展知识（上）.md` - 世界书激活机制详解
4. `酒馆世界书拓展知识（下）.md` - 世界书高级用法
5. `额外输出格式.md` - AI输出格式设计方法论

---

## 🎯 文档主要内容和主题

### 1. **MVU框架的角色卡制作教程**
这是一个完整的变量系统使用指南，涵盖从基础设置到高级应用的所有内容：

#### 核心主题：
- **变量初始化**：通过 `[initvar]` 世界书条目设置初始变量
- **变量结构设计**：使用 YAML/TOML/JSON5 构建层级化变量结构
- **变量提示词**：让AI理解和操作变量的提示词编写方法
- **变量更新机制**：通过 `_.set()` 命令实现动态变量更新
- **酒馆正则应用**：使用正则表达式处理AI输出的变量更新文本

#### 关键概念：
- **stat_data**：所有变量的存储容器
- **宏 (macro)**：如 `{{get_message_variable::变量路径}}` 用于插入变量值
- **思维链 (CoT)**：在变量更新前让AI进行分析推理
- **check-recall模式**：通过check定义规则，让AI在更新时recall这些规则

### 2. **酒馆世界书拓展知识（上）- 激活机制**
深入讲解酒馆世界书的激活系统，这是理解整个提示词系统的基础：

#### 核心主题：
- **基本术语**：世界书条目、提示词、启用、激活、递归等概念
- **激活策略**：
  - 🔵 蓝灯 (constant)：无条件激活
  - 🟢 绿灯 (selective)：基于关键字条件激活
  - 🔗 向量化 (vectorized)：基于向量相似度激活
- **关键字匹配**：
  - 精确文本匹配
  - 逻辑组合：与任意、与所有、非所有、非任何
  - 正则表达式匹配
- **递归扫描**：已激活条目可以激活其他条目
- **扫描深度**：控制扫描最近N条消息

#### 激活流程：
```
正文消息 → 宏替换 → 正则处理 → 第一轮激活
         ↓
   激活的条目内容 → 宏替换 → 正则处理 → 第二轮激活
         ↓
   继续递归直到无新条目被激活
```

### 3. **酒馆世界书拓展知识（下）- 高级用法**
介绍世界书的高级应用技巧和提示词组织方法：

#### 核心主题：
- **组合和命名提示词**：
  - 使用XML标签组织提示词块
  - YAML文档结构（用`---`分隔）
  - YAML锚点语法复用内容
- **变量提示词三要素**：
  1. 变量列表（当前值）
  2. 变量更新规则（何时更新）
  3. 变量更新格式（如何输出）
- **深度控制 (D0-D4)**：不同位置插入不同内容
- **模块化设计**：条目按功能分离，通过激活机制组合

#### 高级技巧：
- 专门用于激活其他条目的"激活条目"
- 分阶段条目（基于变量值激活不同内容）
- 一次性条目（冷却值设置）
- 动态世界书（通过宏和正则实现）

### 4. **额外输出格式**
一套系统化的AI输出格式设计方法论：

#### 核心语法：
- `${描述}`：AI根据描述填充内容
- `$(要求)`：AI遵循要求但不输出
- `...`：AI仿照前面格式继续输出
- 其他内容：原封不动输出

#### 设计模式：
```yaml
---
功能名称:
  rule: 输出规则说明
  format: |-
    <xml_tag>
    固定格式文本
    ${需要AI填充的部分}
    ...
    </xml_tag>
```

#### 应用场景：
- 状态栏系统
- 思维链格式
- 选择框系统
- 任务提示框
- 立绘/背景调用
- JSON结构化输出

---

## 🛠️ 涉及的技术栈和工具

### 主要平台和工具
1. **酒馆 (SillyTavern/TavernAI)**
   - AI对话平台
   - 世界书系统
   - 宏系统
   - 正则表达式引擎
   - API配置（聊天补全模式）

2. **MVU (MagVarUpdate) 框架**
   - 变量管理脚本
   - CDN引入：`https://testingcf.jsdelivr.net/gh/MagicalAstrogy/MagVarUpdate/artifact/bundle.js`
   - 自动解析 JSON5/TOML/YAML 格式
   - 提供 `_.set()` 变量更新命令

3. **酒馆助手**
   - 扩展宏功能
   - 提供 `{{get_message_variable::变量}}` 宏
   - 变量管理器界面
   - 提示词查看器

### 数据格式
1. **YAML**（强烈推荐）
   - 层级结构清晰
   - 支持注释 `#`
   - 支持文档分隔 `---` 和 `...`
   - 支持锚点 `&名字` 和引用 `*名字`
   - 支持数组：`[a, b, c]` 或换行 `- a`

2. **JSON5**
   - 支持注释
   - 更灵活的JSON语法

3. **TOML**
   - 配置文件风格

### 正则表达式
- **仅格式显示**：控制界面显示内容
- **仅格式提示词**：控制发送给AI的内容
- 最小深度设置
- 用于处理变量更新输出、思维链等

### 前端技术（高级功能）
- **Embedded JavaScript (EJS)**：提示词模板
- **TypeScript/Zod**：定义JSON输出结构
- 前端界面实时编写

---

## ⚙️ 关键配置和使用说明

### 1. MVU框架部署流程

#### 步骤1：创建局部脚本
```
酒馆右上角积木按钮 → 酒馆助手 → 脚本库 → + 脚本
```
填入内容：
```javascript
import 'https://testingcf.jsdelivr.net/gh/MagicalAstrogy/MagVarUpdate/artifact/bundle.js';
```

#### 步骤2：创建 `[initvar]` 条目
- 在世界书中新建条目，名称包含 `[initvar]`
- **必须禁用该条目**（不发送给AI）
- 在内容中编写YAML格式变量

示例结构：
```yaml
角色:
  络络:
    好感度: 30
    心情: 开心
  青空莉:
    好感度: 60
    心情: 郁闷
世界:
  日期: 2025-07-26
  时间: 21:00
```

#### 步骤3：验证变量加载
1. API配置选择"聊天补全"
2. 新开聊天（需要有开局消息）
3. 点击输入栏左侧魔棒图标
4. 查看"变量管理器 → 消息楼层"选项卡

### 2. 变量提示词配置

#### 基本结构
```yaml
---
<status_description>
# 以下内容是当前的状态数值，你可以通过命令进行操作修改，但绝对不要将以下内容直接输出在你的回复中
角色:
  络络:
    好感度: {{get_message_variable::stat_data.角色.络络.好感度}} # 0-100
    心情: {{get_message_variable::stat_data.角色.络络.心情}} # 仅有开心、难过、哭泣、生气四种心情
</status_description>
rule: 你必须在下次回复的末尾输出变量更新分析
check:
  - 如果角色注意到了<user>的行为，根据他们的态度将'好感度'更新±(1~4)
  - 根据剧情和人设适当地调整'心情'
  - 根据当前日期时间更新'日期'和'时间'
format: |-
  <update>
  <update_analysis>$(使用不超过120个英语单词)
  - ${计算经过的时间: ...}
  - ${根据当前情节是否足够特殊、时间跨度是否远超正常情况，判断是否允许变量值发生戏剧性变化: 是/否}
  - ${基于变量对应的`check`，仅根据当前回复而不是之前的剧情来分析每个变量是否需要更新: ...}
  </update_analysis>
  _.set('${变量, 例如'角色.络络.好感度'}', ${旧值}, ${新值}); // ${简述更新原因}
  _.set('${变量}, ${新值}); // ${简述更新原因}
  ...
  </update>
```

#### 关键宏命令
- `{{get_message_variable::stat_data}}` - 获取所有变量（JSON格式）
- `{{get_message_variable::stat_data.角色.络络.好感度}}` - 获取特定变量值
- `{{get_message_variable::stat_data.角色.络络.心情[0]}}` - 获取数组第一个元素
- `<user>` - 用户名（推荐使用，支持嵌套）
- `{{char}}` - 角色卡名

#### 酒馆正则设置
创建正则来移除AI输出的 `<update>` 块：
```
触发时机: AI输出
查找: /<update>[\s\S]*?<\/update>/gm
替换: （空）
仅格式显示: ✓
```

### 3. 世界书全局推荐设置

- **扫描深度**: 2（扫描最后2条消息）
- **递归扫描**: 启用
- **压缩系统消息**: 启用
- API配置提示词后处理: 严格

### 4. 世界书条目配置示例

#### 蓝灯常驻条目
```
激活策略: 常量 (🔵)
插入位置: D1 或 D4
启用: ✓
```

#### 绿灯条件激活条目
```
激活策略: 可选项 (🟢)
主要关键字: 络络, 女皇, 笨蛋
扫描深度: 2
启用: ✓
```

#### 绿灯与逻辑条目
```
激活策略: 可选项 (🟢)
主要关键字: 络络, 女皇
逻辑: 与任意
可选过滤器: 社团活动室, 天台
```

#### 激活条目模式
创建一个专门用于激活其他条目的条目：
```
条目名: 络络-激活
激活策略: 可选项 (🟢)
主要关键字: 络络, 女皇, 笨蛋
内容: 络络
防止进一步递归: ✗（允许递归）
```

然后其他络络相关条目：
```
条目名: 络络-详情, 络络-阶段1, 络络-阶段2
激活策略: 可选项 (🟢)
主要关键字: 络络
不可递归: ✗（可递归）
```

### 5. 插入深度策略 (D0-D4)

- **D0 (最后)**：格式强调、简短提醒
- **D1 (Before Chara Defs)**：变量当前值、状态栏模板简化版
- **D2-D3**：较少使用
- **D4 (After Example Messages)**：完整的规则说明、详细格式定义、变量更新规则

典型配置：
```
D4: 完整的变量更新规则 + 完整的输出格式定义
D1: 当前变量列表 + 格式模板（仅包含 ... 的简化版）
D0: 格式强调（如 "我必须输出<update>"）
```

---

## 🏗️ 项目整体架构和组织方式

### 系统架构层次

```
┌─────────────────────────────────────────────────────┐
│                   酒馆 (SillyTavern)                │
├─────────────────────────────────────────────────────┤
│  角色卡                                              │
│   ├─ 角色描述                                        │
│   ├─ 开局消息（可包含初始 _.set() 命令）            │
│   └─ 示例对话                                        │
├─────────────────────────────────────────────────────┤
│  预设 (Preset)                                      │
│   ├─ 系统提示词                                      │
│   ├─ 压缩系统消息选项                               │
│   └─ 预设内嵌入的世界书条目                         │
├─────────────────────────────────────────────────────┤
│  世界书 (World Info)                                │
│   ├─ [initvar] 条目（禁用）                         │
│   ├─ 蓝灯条目（常驻）                               │
│   │   ├─ 变量列表（D1）                             │
│   │   ├─ 变量规则（D4）                             │
│   │   └─ 输出格式（D4 完整版 + D0 强调版）          │
│   ├─ 绿灯条目（按需激活）                           │
│   │   ├─ 激活条目（用于递归激活）                   │
│   │   ├─ 角色详情条目                               │
│   │   ├─ 角色阶段条目（分阶段）                     │
│   │   └─ 事件条目                                   │
│   └─ 递归配置                                        │
├─────────────────────────────────────────────────────┤
│  酒馆助手 (Tavern Extras)                           │
│   ├─ MVU 脚本（局部脚本）                           │
│   ├─ 变量管理器                                      │
│   ├─ 提示词查看器                                    │
│   └─ 自定义宏                                        │
├─────────────────────────────────────────────────────┤
│  酒馆正则 (Regex)                                   │
│   ├─ 仅格式显示（控制界面）                         │
│   └─ 仅格式提示词（控制发送内容）                   │
├─────────────────────────────────────────────────────┤
│  前端界面（高级）                                    │
│   └─ 实时编写的自定义UI                             │
└─────────────────────────────────────────────────────┘
```

### 数据流向

```
初始化阶段:
[initvar]条目(YAML) → MVU脚本解析 → stat_data变量存储

每轮对话:
1. 用户输入 → 正文消息
2. 正文 → 宏替换 → 正则处理 → 欲扫描文本
3. 世界书扫描:
   欲扫描文本 → 第1轮激活 → 获得条目A、B
   条目A、B → 宏替换 → 正则处理 → 加入欲扫描文本
   新欲扫描文本 → 第2轮激活 → 获得条目C、D
   ... 直到无新条目激活
4. 组装最终提示词:
   - D4位置插入条目
   - D2-D3位置插入条目
   - D1位置插入条目（含变量当前值）
   - 正文消息
   - D0位置插入条目
5. 发送给AI → AI生成回复（含 <update>...</update>）
6. MVU脚本读取AI输出中的 _.set() 命令 → 更新 stat_data
7. 正则处理AI输出 → 移除 <update> 块 → 显示给用户
```

### 模块化设计原则

#### 1. 分离关注点
- **变量系统**：[initvar]条目 + 变量提示词条目
- **角色系统**：激活条目 + 详情条目 + 阶段条目 + 关键信息条目
- **输出系统**：状态栏条目 + 思维链条目 + 选择框条目
- **事件系统**：特殊事件条目

#### 2. 复用机制
- 使用激活条目统一管理关键字
- 使用YAML锚点复用配置
- 使用 `${引用}` 语法嵌套输出格式
- 使用宏插入动态内容

#### 3. 条目命名规范
```
功能类型-具体内容-版本/变体
例如:
- 络络-激活
- 络络-详情
- 络络-阶段1-羞涩
- 络络-阶段2-欲拒还迎
- 变量-列表-D1
- 变量-规则-D4
- 状态栏-完整-D4
- 状态栏-强调-D0
```

#### 4. 插入位置策略
```
D4: 规则定义层
    ├─ 变量更新规则（完整check）
    ├─ 输出格式定义（完整format）
    └─ 角色详细设定

D1: 状态数据层
    ├─ 当前变量值
    ├─ 角色当前阶段
    └─ 输出格式简化版（仅 ... 提醒）

D0: 强化提醒层
    ├─ 格式强调（"我必须..."）
    └─ 关键规则重申
```

---

## 🎓 核心设计理念

### 1. "这只是提示词"
- 所有YAML、JSON、XML都只是为了让AI更好理解
- 不需要完美的语法，只要AI能理解即可
- 灵活运用各种格式达到最佳效果

### 2. 结构化优于平铺
```yaml
# 推荐：结构化
角色:
  络络:
    好感度: 30
    心情: 开心

# 不推荐：平铺（除非变量很少）
络络的好感度: 30
络络的心情: 开心
```

### 3. 分离数据与规则
- 数据（变量值）应该动态（D1）
- 规则（更新逻辑）应该静态（D4）
- 格式（输出模板）分完整版（D4）和简化版（D0）

### 4. 递归激活的威力
通过递归机制，实现：
- 一个关键字激活多个相关条目
- 条目按需加载，节省token
- 动态世界书效果

### 5. 思维链保证质量
```yaml
format: |-
  <update>
  <update_analysis>
  - ${分析时间变化}
  - ${判断是否特殊情况}
  - ${逐个变量分析是否需要更新}
  </update_analysis>
  _.set(变量, 新值); // 原因
  </update>
```
让AI先思考再更新，显著提升变量更新质量。

---

## 📚 典型应用案例参考

文档中提到的实际案例：

1. **日记络络** - 使用立绘/背景系统，JSON格式输出
2. **元首自改版** - D4规则 + D1数据 + D0强调的经典结构
3. **妹妹请求你保护她露出** - 任务系统 + 积分系统 + 条件变量
4. **可点击的选择框** - 自定义选项类型的模块化设计

---

## 🔧 常见问题和注意事项

### 变量系统
- ❌ **不要**启用 `[initvar]` 条目
- ✅ **必须**在"聊天补全"模式下新开聊天才能初始化变量
- ✅ **推荐**使用YAML格式，结构清晰且支持注释
- ⚠️ 数组索引从 `[0]` 开始
- ⚠️ 变量路径使用点号分隔：`stat_data.角色.络络.好感度`

### 世界书激活
- ❌ **避免**在递归中使用"非所有"和"非任意"逻辑
- ✅ **推荐**全局扫描深度设置为 2
- ✅ 使用 `/./s` 正则让绿灯始终激活
- ⚠️ 绿灯必须有至少一个关键字
- ⚠️ "延迟到递归"可能导致条目永远不被激活

### 输出格式
- ✅ 使用 `format: |-` 标记输出格式
- ✅ 在D4给完整格式，D0给简化提醒
- ✅ 用 `<xml_tag>` 包裹便于正则处理
- ⚠️ `${描述}` 可以引用其他提示词内容

### 性能优化
- 使用"仅格式提示词"正则减少发送内容
- 合理设置扫描深度避免过度激活
- 使用激活条目统一管理，避免重复关键字
- 将大段规则说明放在D4而非D0/D1

---

## 💡 进阶技巧速查

1. **分阶段好感度系统**：用正则关键字 `/好感度.*(0-19)/` 匹配不同区间
2. **一次性事件**：冷却值设为 9999 + 适当黏性值
3. **动态内容引用**：`<%= YAML.stringify(getvar(stat_data)) _%>`
4. **条件提示词**：`<%_ if (条件) { _%>内容<%_ } _%>`
5. **YAML锚点复用**：`&名字` 定义，`*名字` 使用，`<<: *名字` 继承并覆盖
6. **recall机制**：让AI在思维链中回忆check规则
7. **TypeScript类型定义**：用interface或zod定义JSON输出结构
8. **前端界面集成**：通过酒馆助手前端界面功能实现自定义UI

---

## 🎯 Vibe Coding 建议

基于文档内容，后续开发时应该：

1. **遵循现有模式**：
   - YAML作为主要格式
   - XML标签组织提示词
   - D4规则+D1数据+D0强调的三层结构

2. **保持模块化**：
   - 每个功能独立条目
   - 通过激活机制组合
   - 使用引用而非复制粘贴

3. **注重AI体验**：
   - 清晰的变量命名
   - 充分的注释说明
   - 结构化的数据格式

4. **性能意识**：
   - 合理使用递归
   - 控制扫描深度
   - 正则优化token使用

5. **测试验证**：
   - 使用变量管理器检查变量
   - 使用提示词查看器检查激活
   - 用提示词模板预处理功能测试条件逻辑

---

**文档版本**: 基于 /docs 目录的2025年内容
**总结生成时间**: 2025
**用途**: vibe coding 参考资料
